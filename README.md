
# Kubernetes Cluster Setup using Vagrant

## Prerequisites:

- **Vagrant**: Install Vagrant from [here](https://www.vagrantup.com/docs/installation).
- **VirtualBox**: Install VirtualBox from [here](https://www.virtualbox.org/wiki/Downloads).

---

## Steps:

### 1. **Navigate to the Vagrant Folder**

```bash
cd /path/to/your/vagrant/folder
```

---

### 2. **Start the Vagrant Environment**

```bash
vagrant up
```

---

### 3. **SSH into the Master and Worker Nodes**

- **Master Node**:

```bash
vagrant ssh kube_master
```

- **Worker Node**:

```bash
vagrant ssh kube_worker
```

---

### 4. **Initialize Kubernetes on the Master Node**

On the master node, initialize the Kubernetes cluster with `kubeadm`:

```bash
kubeadm init --pod-network-cidr=10.10.0.0/16 --apiserver-advertise-address=192.168.56.24
```

---

### 5. **Join the Worker Node to the Cluster**

- On the worker node, run the following command (use the token and hash generated by the `kubeadm init` command):

```bash
kubeadm join 192.168.56.20:6443 --token <your_token> --discovery-token-ca-cert-hash sha256:<your_hash>
```

---

### 6. **Configure kubectl on the Master Node**

On the master node, configure `kubectl` for the `kube` user:

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

---

### 7. **Download and Configure Flannel for Pod Networking**

Download Flannel's YAML configuration for Kubernetes:

```bash
wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
```

---

### 8. **Set the Correct Network Interface and CIDR in Flannel Configuration**

Determine the correct network interface and CIDR by running:

```bash
IFACE=$(ip a | grep 192 | rev | tr -s ' ' | cut -d' ' -f '1' | rev)
```

Next, modify the Flannel configuration to reflect the correct CIDR and network interface:

```bash
sed -i 's/10.244.0.0/10.10.0.0/' kube-flannel.yml
sed -i '/^.*kube-subnet/ a \        - --iface='"$IFACE"'' kube-flannel.yml
```

---

### 9. **Apply the Flannel Configuration to the Cluster**

Apply the Flannel configuration:

```bash
kubectl apply -f kube-flannel.yml
```

---

### 10. **Verify that the Nodes are Working**

Check the status of the nodes in your Kubernetes cluster:

```bash
kubectl get nodes
```

---

## Kubernetes Cluster Setup Complete!

You have successfully set up a Kubernetes cluster using Vagrant. 

---

## Next Steps: Run and Deploy Your Application

1. **Clone Your Repository and Build Docker Containers**

   On your local machine, use Docker Compose to build your Docker containers:

   ```bash
   docker compose up --build
   ```

2. **Push the Built Images to Docker Hub**

   After building the images, push them to Docker Hub:

   ```bash
   docker push <your_image_name>
   ```

3. **Update Kubernetes Deployment Configuration**

   Update the `deployment.yml` file with the new image name and apply it to the cluster:


## Clone the Repo on the Master Node of the Kubernetes Cluster

1. SSH into the master node:

   ```bash
   vagrant ssh kube_master
   ```

2. Install Git on the master node:

   ```bash
   sudo yum install git
   ```

3. Clone your repository:

   ```bash
   git clone <your_repo_url>
   ```

---

## Deploy ELK Stack in Kubernetes

The ELK stack (Elasticsearch, Logstash, and Kibana) will be used for centralized logging, useful for monitoring and troubleshooting.

1. **Apply ELK Stack YAML Files**

   First, apply the YAML files for the ELK stack:

   ```bash
   kubectl apply -f   ```

   Apply the following files in order:
   - `elasticsearch-deployment.yml`
   - `filebeat-configmap.yml`
   - `filebeat.yml`
   - `kibana-deployment.yml`
   - `logstash-deployment.yml`

---

## Set Up the Application Components

After deploying the ELK stack, proceed with deploying your Java application components.

1. **Database Setup**

   Apply the necessary database YAML files:

   ```bash
   kubectl apply -f 
   ```

   This will set up the database and related resources. The following files will be applied:
   - `db-deployment.yml`
   - `db-pv-claim.yml`
   - `db-pv.yml`
   - `db-secret.yml`
   - `db-service.yml`

2. **Java Application Setup**

   Now, deploy the Java application:

   ```bash
   kubectl apply -f 
   ```

   Apply the following files:
   - `deployment.yml`
   - `service.yml`
   - `ingress.yml`

---

### Ensure All Resources Are Configured

Before applying, double-check that you have all the necessary Docker images, Kubernetes configurations, and environment-specific values set up in your YAML files.
